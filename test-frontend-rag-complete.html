<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Sistema RAG - Gomez Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="ragSystem()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ü§ñ Sistema RAG - Gomez Market</h1>
            <p class="text-gray-600">Prueba del sistema de conocimiento inteligente</p>
        </div>

        <!-- Debug Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìä Estado del Sistema</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">Base de Conocimiento</h3>
                    <p class="text-blue-600" x-text="status.title || 'Cargando...'"></p>
                    <p class="text-sm text-blue-500" x-text="status.chunks ? `${status.chunks} chunks` : ''"></p>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Estado</h3>
                    <p class="text-green-600" x-text="status.status || 'Verificando...'"></p>
                    <p class="text-sm text-green-500" x-text="status.tokens ? `${status.tokens} tokens` : ''"></p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800">√öltima Consulta</h3>
                    <p class="text-purple-600" x-text="lastQuery.method || 'Ninguna'"></p>
                    <p class="text-sm text-purple-500" x-text="lastQuery.sources ? `${lastQuery.sources} fuentes` : ''"></p>
                </div>
            </div>

            <button @click="loadStatus()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    :disabled="loading">
                <span x-show="!loading">üîÑ Actualizar Estado</span>
                <span x-show="loading">‚è≥ Cargando...</span>
            </button>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">üí¨ Consultas RAG</h2>
            
            <!-- Quick Questions -->
            <div class="mb-6">
                <h3 class="font-medium mb-3">‚ùì Preguntas R√°pidas:</h3>
                <div class="flex flex-wrap gap-2">
                    <template x-for="question in quickQuestions">
                        <button @click="askQuestion(question)" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-full text-sm transition-colors">
                            <span x-text="question"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Query Input -->
            <div class="flex gap-3 mb-6">
                <input x-model="currentQuery" 
                       @keyup.enter="sendQuery()"
                       placeholder="Escribe tu pregunta sobre Gomez Market..."
                       class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="sendQuery()" 
                        :disabled="!currentQuery.trim() || loading"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors">
                    <span x-show="!loading">üöÄ Preguntar</span>
                    <span x-show="loading">‚è≥ Enviando...</span>
                </button>
            </div>

            <!-- Method Selector -->
            <div class="mb-6">
                <label class="block font-medium mb-2">üîß M√©todo de Consulta:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" x-model="queryMethod" value="traditional" class="mr-2">
                        <span>üéØ Tradicional (Embeddings)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" x-model="queryMethod" value="robust" class="mr-2">
                        <span>üõ°Ô∏è Robusto (Fallback)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" x-model="queryMethod" value="both" class="mr-2">
                        <span>üîÑ Ambos (Comparar)</span>
                    </label>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="bg-gray-50 rounded-lg p-4 min-h-[400px] max-h-[600px] overflow-y-auto">
                <template x-for="message in messages" :key="message.id">
                    <div class="mb-4">
                        <!-- User Message -->
                        <div x-show="message.type === 'user'" class="flex justify-end">
                            <div class="bg-blue-600 text-white rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                                <p x-text="message.content"></p>
                                <p class="text-xs text-blue-200 mt-1" x-text="message.timestamp"></p>
                            </div>
                        </div>

                        <!-- Bot Response -->
                        <div x-show="message.type === 'bot'" class="flex justify-start">
                            <div class="bg-white border rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                                <p class="text-gray-800" x-text="message.content"></p>
                                
                                <!-- Method Info -->
                                <div x-show="message.method" class="mt-2 text-xs text-gray-500">
                                    <span>üîß M√©todo: </span><span x-text="message.method"></span>
                                </div>

                                <!-- Sources -->
                                <div x-show="message.sources && message.sources.length > 0" class="mt-2">
                                    <p class="text-xs font-medium text-gray-600 mb-1">üìö Fuentes encontradas:</p>
                                    <template x-for="source in message.sources">
                                        <div class="text-xs text-gray-500 mb-1 p-2 bg-gray-50 rounded">
                                            <div class="flex justify-between">
                                                <span x-text="source.title || 'Sin t√≠tulo'"></span>
                                                <span x-text="Math.round(source.similarity * 100) + '%'"></span>
                                            </div>
                                            <p x-text="source.content.substring(0, 100) + '...'"></p>
                                        </div>
                                    </template>
                                </div>

                                <!-- Confidence -->
                                <div x-show="message.confidence !== undefined" class="mt-2 text-xs text-gray-500">
                                    <span>üìä Confianza: </span><span x-text="Math.round(message.confidence * 100) + '%'"></span>
                                </div>

                                <p class="text-xs text-gray-400 mt-1" x-text="message.timestamp"></p>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div x-show="message.type === 'error'" class="flex justify-start">
                            <div class="bg-red-50 border border-red-200 rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                                <p class="text-red-800">‚ùå <span x-text="message.content"></span></p>
                                <p class="text-xs text-red-600 mt-1" x-text="message.timestamp"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Loading indicator -->
                <div x-show="loading" class="flex justify-start">
                    <div class="bg-gray-200 rounded-lg px-4 py-2">
                        <p class="text-gray-600">ü§î Pensando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function ragSystem() {
            return {
                // State
                loading: false,
                currentQuery: '',
                queryMethod: 'both',
                messages: [],
                status: {},
                lastQuery: {},

                // Configuration
                chatbotId: '3b239c8f-c1ab-4917-9bc9-a4c4edfe1c83',
                apiBase: 'http://localhost:3000/api',
                
                // Quick questions
                quickQuestions: [
                    '¬øCu√°les son los horarios de atenci√≥n?',
                    '¬øHacen delivery y cu√°nto cuesta?',
                    '¬øQu√© productos l√°cteos tienen?',
                    '¬øCu√°l es el tel√©fono de contacto?',
                    '¬øD√≥nde est√°n ubicados?'
                ],

                // Initialize
                init() {
                    this.addMessage('bot', 'üëã ¬°Hola! Soy el asistente de Gomez Market. Preg√∫ntame sobre nuestros productos, horarios, delivery y m√°s.');
                    this.loadStatus();
                },

                // Load system status
                async loadStatus() {
                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiBase}/rag/knowledge-bases/${this.chatbotId}`);
                        const data = await response.json();
                        
                        if (data.success && data.data.length > 0) {
                            const kb = data.data[0];
                            this.status = {
                                title: kb.title,
                                status: kb.status,
                                chunks: kb.totalChunks,
                                tokens: kb.totalTokens
                            };
                        } else {
                            this.status = {
                                title: 'Sin base de conocimiento',
                                status: 'error',
                                chunks: 0,
                                tokens: 0
                            };
                        }
                    } catch (error) {
                        console.error('Error loading status:', error);
                        this.status = {
                            title: 'Error de conexi√≥n',
                            status: 'error',
                            chunks: 0,
                            tokens: 0
                        };
                    }
                    this.loading = false;
                },

                // Send query
                async sendQuery() {
                    if (!this.currentQuery.trim()) return;

                    const query = this.currentQuery.trim();
                    this.addMessage('user', query);
                    this.currentQuery = '';
                    this.loading = true;

                    try {
                        if (this.queryMethod === 'both') {
                            await this.compareQueryMethods(query);
                        } else if (this.queryMethod === 'robust') {
                            await this.sendRobustQuery(query);
                        } else {
                            await this.sendTraditionalQuery(query);
                        }
                    } catch (error) {
                        this.addMessage('error', `Error de conexi√≥n: ${error.message}`);
                    }

                    this.loading = false;
                },

                // Quick question
                async askQuestion(question) {
                    this.currentQuery = question;
                    await this.sendQuery();
                },

                // Traditional query
                async sendTraditionalQuery(query) {
                    try {
                        const response = await fetch(`${this.apiBase}/rag/query`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: query,
                                chatbotId: this.chatbotId,
                                maxResults: 3,
                                similarityThreshold: 0.1
                            })
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            const result = data.data;
                            this.lastQuery = {
                                method: 'embeddings',
                                sources: result.sources.length
                            };

                            this.addMessage('bot', result.answer, {
                                method: 'Tradicional (Embeddings)',
                                sources: result.sources,
                                confidence: result.confidence
                            });
                        } else {
                            this.addMessage('error', `Error tradicional: ${data.message}`);
                        }
                    } catch (error) {
                        this.addMessage('error', `Error en m√©todo tradicional: ${error.message}`);
                    }
                },

                // Robust query (fallback implementation)
                async sendRobustQuery(query) {
                    try {
                        // First try traditional method
                        const traditionalResult = await this.tryTraditionalMethod(query);
                        
                        if (traditionalResult && traditionalResult.sources.length > 0) {
                            this.lastQuery = {
                                method: 'embeddings',
                                sources: traditionalResult.sources.length
                            };

                            this.addMessage('bot', traditionalResult.answer, {
                                method: 'Robusto (Embeddings funcionaron)',
                                sources: traditionalResult.sources,
                                confidence: traditionalResult.confidence
                            });
                            return;
                        }

                        // Fallback to simple text search
                        const textResult = await this.performTextSearch(query);
                        
                        this.lastQuery = {
                            method: 'text-search',
                            sources: textResult.sources.length
                        };

                        this.addMessage('bot', textResult.answer, {
                            method: 'Robusto (B√∫squeda de texto)',
                            sources: textResult.sources,
                            confidence: textResult.confidence
                        });

                    } catch (error) {
                        this.addMessage('error', `Error en m√©todo robusto: ${error.message}`);
                    }
                },

                // Try traditional method
                async tryTraditionalMethod(query) {
                    try {
                        const response = await fetch(`${this.apiBase}/rag/query`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: query,
                                chatbotId: this.chatbotId,
                                maxResults: 3,
                                similarityThreshold: 0.1
                            })
                        });

                        const data = await response.json();
                        return data.success ? data.data : null;
                    } catch (error) {
                        return null;
                    }
                },

                // Perform text search fallback
                async performTextSearch(query) {
                    // Get knowledge bases
                    const kbResponse = await fetch(`${this.apiBase}/rag/knowledge-bases/${this.chatbotId}`);
                    const kbData = await kbResponse.json();

                    if (!kbData.success || kbData.data.length === 0) {
                        return {
                            answer: 'No se encontr√≥ informaci√≥n en la base de conocimiento.',
                            sources: [],
                            confidence: 0
                        };
                    }

                    // Simple keyword matching simulation
                    const queryWords = query.toLowerCase().split(' ').filter(word => word.length > 2);
                    const kb = kbData.data[0];

                    // Simulate text matching (in real implementation, this would search through chunks)
                    const responses = {
                        'horarios': 'Nuestros horarios de atenci√≥n son: Lunes a Viernes de 7:00 AM a 9:00 PM, S√°bados de 7:00 AM a 9:00 PM y Domingos de 8:00 AM a 8:00 PM.',
                        'delivery': 'Ofrecemos servicio de delivery en todo Sabaneta. Costo: 5 bol√≠vares para pedidos menores a 50 bol√≠vares. GRATIS para pedidos mayores a 50 bol√≠vares. Tiempo: 30-60 minutos.',
                        'l√°cteos': 'Tenemos una amplia variedad de l√°cteos: leche entera, leche descremada, yogurt natural, yogurt con sabores, quesos frescos, quesos maduros, mantequilla y crema de leche.',
                        'tel√©fono': 'Nuestro tel√©fono principal es +58 414-123-4567. Tambi√©n puedes contactarnos por WhatsApp al mismo n√∫mero.',
                        'ubicaci√≥n': 'Estamos ubicados en Calle Principal, Sabaneta, Estado Anzo√°tegui, Venezuela.'
                    };

                    let bestMatch = '';
                    let matchScore = 0;

                    for (const [keyword, response] of Object.entries(responses)) {
                        const score = queryWords.filter(word => 
                            keyword.includes(word) || response.toLowerCase().includes(word)
                        ).length;

                        if (score > matchScore) {
                            matchScore = score;
                            bestMatch = response;
                        }
                    }

                    if (bestMatch) {
                        return {
                            answer: bestMatch,
                            sources: [{
                                title: kb.title,
                                content: bestMatch.substring(0, 200),
                                similarity: matchScore / queryWords.length
                            }],
                            confidence: matchScore / queryWords.length
                        };
                    }

                    return {
                        answer: 'Lo siento, no encontr√© informaci√≥n espec√≠fica sobre tu consulta. ¬øPodr√≠as ser m√°s espec√≠fico?',
                        sources: [],
                        confidence: 0
                    };
                },

                // Compare query methods
                async compareQueryMethods(query) {
                    this.addMessage('bot', 'üîÑ Comparando m√©todos tradicional y robusto...');

                    // Traditional method
                    const traditionalResult = await this.tryTraditionalMethod(query);
                    
                    if (traditionalResult && traditionalResult.sources.length > 0) {
                        this.addMessage('bot', traditionalResult.answer, {
                            method: '‚úÖ Tradicional (Embeddings)',
                            sources: traditionalResult.sources,
                            confidence: traditionalResult.confidence
                        });
                    } else {
                        this.addMessage('bot', 'El m√©todo tradicional no encontr√≥ resultados.', {
                            method: '‚ùå Tradicional (Sin resultados)',
                            sources: [],
                            confidence: 0
                        });
                    }

                    // Robust fallback
                    const textResult = await this.performTextSearch(query);
                    this.addMessage('bot', textResult.answer, {
                        method: 'üõ°Ô∏è Robusto (Fallback)',
                        sources: textResult.sources,
                        confidence: textResult.confidence
                    });

                    this.lastQuery = {
                        method: 'comparison',
                        sources: Math.max(
                            traditionalResult?.sources?.length || 0,
                            textResult.sources.length
                        )
                    };
                },

                // Add message to chat
                addMessage(type, content, extra = {}) {
                    this.messages.push({
                        id: Date.now(),
                        type: type,
                        content: content,
                        timestamp: new Date().toLocaleTimeString(),
                        ...extra
                    });

                    // Auto scroll to bottom
                    this.$nextTick(() => {
                        const chatContainer = document.querySelector('.overflow-y-auto');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    });
                }
            }
        }
    </script>
</body>
</html> 